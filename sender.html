<!DOCTYPE html>
<html>
<head>
  <title>Camera Sender</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>Camera Sender</h2>
  <video id="video" autoplay playsinline></video>

  <script>
    alert("üìå Sender page loaded"); // Debug 1

    // üîπ Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBbOZTdTJWhqApJGDeep5gSRXHUbMOZ8_E",
      authDomain: "live-stream-b4723.firebaseapp.com",
      projectId: "live-stream-b4723",
      storageBucket: "live-stream-b4723.appspot.com",
      messagingSenderId: "924150539091",
      appId: "1:924150539091:web:e4b23806165e39b3f437a6",
      measurementId: "G-QYJ816DFZH"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      alert("‚úÖ Firebase initialized"); // Debug 2

      async function init() {
        try {
          // Get camera
          const localVideo = document.getElementById("video");
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          localVideo.srcObject = stream;
          alert("üì∑ Camera started"); // Debug 3

          // Peer connection
          const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
          stream.getTracks().forEach(track => pc.addTrack(track, stream));

          // Firestore call document
          const callDoc = db.collection("calls").doc();
          alert("üìù Firestore doc created: " + callDoc.id); // Debug 4

          const offerCandidates = callDoc.collection("offerCandidates");
          const answerCandidates = callDoc.collection("answerCandidates");

          pc.onicecandidate = event => {
            if (event.candidate) {
              offerCandidates.add(event.candidate.toJSON());
            }
          };

          // Create and set offer
          const offerDescription = await pc.createOffer();
          await pc.setLocalDescription(offerDescription);

          await callDoc.set({ offer: { sdp: offerDescription.sdp, type: offerDescription.type } });
          alert("üìå Share this Call ID with Receiver:\n\n" + callDoc.id); // Debug 5
        } catch (err) {
          alert("‚ùå Error inside init(): " + err.message);
        }
      }

      init();
    } catch (err) {
      alert("‚ùå Firebase error: " + err.message);
    }
  </script>
</body>
</html>
