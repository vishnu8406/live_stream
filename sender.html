<!DOCTYPE html>
<html>
<head>
  <title>Camera Sender</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>ğŸ“± Camera Sender</h2>
  <video id="video" autoplay playsinline style="width:100%; border:2px solid black;"></video>

  <script>
    console.log("ğŸ“¡ Sender page loaded");

    // ğŸ”¹ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBbOZTdTJWhqApJGDeep5gSRXHUbMOZ8_E",
      authDomain: "live-stream-b4723.firebaseapp.com",
      databaseURL: "https://live-stream-b4723-default-rtdb.firebaseio.com",
      projectId: "live-stream-b4723",
      storageBucket: "live-stream-b4723.appspot.com",
      messagingSenderId: "924150539091",
      appId: "1:924150539091:web:e4b23806165e39b3f437a6",
      measurementId: "G-QYJ816DFZH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function init() {
      const localVideo = document.getElementById("video");
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      localVideo.srcObject = stream;
      console.log("ğŸ¥ Camera stream started");

      const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      const callDoc = db.collection("calls").doc();
      const offerCandidates = callDoc.collection("offerCandidates");
      const answerCandidates = callDoc.collection("answerCandidates");

      pc.onicecandidate = event => {
        if (event.candidate) {
          console.log("ğŸ“¨ Sender ICE candidate sent");
          offerCandidates.add(event.candidate.toJSON());
        }
      };

      console.log("âš™ï¸ Creating offer...");
      const offerDescription = await pc.createOffer();
      await pc.setLocalDescription(offerDescription);

      const offer = {
        sdp: offerDescription.sdp,
        type: offerDescription.type,
      };

      await callDoc.set({ offer });
      console.log("âœ… Offer stored with Call ID:", callDoc.id);
      alert("ğŸ“¢ Share this Call ID with Receiver:\n" + callDoc.id);

      callDoc.onSnapshot(snapshot => {
        const data = snapshot.data();
        if (!pc.currentRemoteDescription && data?.answer) {
          console.log("ğŸ“¥ Answer received from receiver");
          const answerDescription = new RTCSessionDescription(data.answer);
          pc.setRemoteDescription(answerDescription);
        }
      });

      answerCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            console.log("ğŸ“¥ Receiver ICE candidate received");
            const candidate = new RTCIceCandidate(change.doc.data());
            pc.addIceCandidate(candidate);
          }
        });
      });
    }

    init();
  </script>
</body>
</html>
