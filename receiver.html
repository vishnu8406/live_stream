<!DOCTYPE html>
<html>
<head>
  <title>Camera Receiver</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>ðŸ’» Camera Receiver (Auto)</h2>
  <button id="startBtn" style="padding:10px; font-size:16px;">Start Receiving</button>
  <video id="remoteVideo" autoplay playsinline muted style="width:100%; height:480px; border:2px solid blue;"></video>

  <script>
    console.log("ðŸ’» Receiver page loaded");

    const firebaseConfig = {
      apiKey: "AIzaSyBbOZTdTJWhqApJGDeep5gSRXHUbMOZ8_E",
      authDomain: "live-stream-b4723.firebaseapp.com",
      projectId: "live-stream-b4723",
      storageBucket: "live-stream-b4723.appspot.com",
      messagingSenderId: "924150539091",
      appId: "1:924150539091:web:e4b23806165e39b3f437a6",
      measurementId: "G-QYJ816DFZH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.getElementById("startBtn").addEventListener("click", async () => {
      document.getElementById("startBtn").disabled = true;
      await init();
    });

    async function init() {
      const currentCallDoc = db.collection("currentCall").doc("active");
      const data = (await currentCallDoc.get()).data();
      if (!data) { alert("âŒ No active sender found"); return; }
      const callId = data.callId;
      console.log("ðŸ“¡ Connecting to Call ID:", callId);

      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          {
            urls: [
              "stun:openrelay.metered.ca:80",
              "stun:openrelay.metered.ca:443",
              "stun:openrelay.metered.ca:3478",
              "turn:openrelay.metered.ca:80",
              "turn:openrelay.metered.ca:443",
              "turn:openrelay.metered.ca:3478"
            ],
            username: "openrelayproject",
            credential: "openrelayproject"
          }
        ]
      });

      const remoteVideo = document.getElementById("remoteVideo");

      pc.ontrack = event => {
        console.log("ðŸŽ¥ Remote stream received");
        remoteVideo.srcObject = event.streams[0];
        remoteVideo.muted = true;
        remoteVideo.onloadedmetadata = () => remoteVideo.play();
      };

      const callDoc = db.collection("calls").doc(callId);
      const offerCandidates = callDoc.collection("offerCandidates");
      const answerCandidates = callDoc.collection("answerCandidates");

      pc.onicecandidate = event => {
        if (event.candidate) answerCandidates.add(event.candidate.toJSON());
      };

      const callData = (await callDoc.get()).data();
      if (!callData) { alert("âŒ Invalid call data"); return; }

      await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
      console.log("âœ… Offer received");

      const answerDescription = await pc.createAnswer();
      await pc.setLocalDescription(answerDescription);

      const answer = { type: answerDescription.type, sdp: answerDescription.sdp };
      await callDoc.update({ answer });
      console.log("âœ… Answer stored");

      offerCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
        });
      });
    }
  </script>
</body>
</html>
