<!DOCTYPE html>
<html>
<head>
  <title>Camera Receiver</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>Camera Receiver</h2>
  <input id="callId" placeholder="Enter Call ID">
  <button onclick="joinCall()">Join</button>
  <video id="remoteVideo" autoplay playsinline></video>

  <script>
    console.log("Receiver page loaded");

    // ðŸ”¹ Your Firebase config here (same as sender)
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBbOZTdTJWhqApJGDeep5gSRXHUbMOZ8_E",
  authDomain: "live-stream-b4723.firebaseapp.com",
  databaseURL: "https://live-stream-b4723-default-rtdb.firebaseio.com",
  projectId: "live-stream-b4723",
  storageBucket: "live-stream-b4723.firebasestorage.app",
  messagingSenderId: "924150539091",
  appId: "1:924150539091:web:e4b23806165e39b3f437a6",
  measurementId: "G-QYJ816DFZH"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function joinCall() {
      const callId = document.getElementById("callId").value;
      const callDoc = db.collection("calls").doc(callId);
      const answerCandidates = callDoc.collection("answerCandidates");
      const offerCandidates = callDoc.collection("offerCandidates");

      const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      const remoteStream = new MediaStream();
      document.getElementById("remoteVideo").srcObject = remoteStream;

      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => {
          remoteStream.addTrack(track);
        });
      };

      pc.onicecandidate = event => {
        if (event.candidate) {
          answerCandidates.add(event.candidate.toJSON());
        }
      };

      const callData = (await callDoc.get()).data();
      const offerDescription = callData.offer;
      await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));

      const answerDescription = await pc.createAnswer();
      await pc.setLocalDescription(answerDescription);

      const answer = {
        type: answerDescription.type,
        sdp: answerDescription.sdp,
      };

      await callDoc.update({ answer });

      offerCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            const data = change.doc.data();
            pc.addIceCandidate(new RTCIceCandidate(data));
          }
        });
      });

      console.log("Receiver joined call:", callId);
    }
  </script>
</body>
</html>
